<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<window xmlns:pivot="http://jmix.io/schema/ui/pivot-table"
        xmlns="http://jmix.io/schema/ui/window"
        caption="msg://demandManagement.caption">
    <data>
        <collection id="demandsDc" class="com.choqnet.budget.entity.Demand">
            <fetchPlan extends="_base">
                <property name="iprb" fetchPlan="_base"/>
                <property name="details" fetchPlan="_base"/>
                <property name="expenses" fetchPlan="_base"/>
                <property name="budget" fetchPlan="_base"/>
            </fetchPlan>
            <loader id="demandsDl">
                <query>
                    <![CDATA[select e from Demand e where e is null]]>
                </query>
            </loader>
        </collection>
        <collection id="detailsDc" class="com.choqnet.budget.entity.Detail" fetchPlan="details">
            <loader id="detailsDl">
                <query>
                    <![CDATA[select e from Detail e where e is null]]>
                </query>
            </loader>
        </collection>
    </data>
    <facets>
        <dataLoadCoordinator auto="true"/>
    </facets>
    <layout spacing="true" expand="screen">
        <hbox spacing="true" width="100%">
            <label stylename="h1" value="Demand Management" align="MIDDLE_LEFT"/>
            <comboBox id="cmbBudget" caption="Pick a budget" align="MIDDLE_RIGHT"/>
        </hbox>
        <tabSheet id="screen">
            <tab caption="Summary" id="summary" spacing="true" expand="demandsTable" margin="true,false,false,false">
                <hbox spacing="true" width="100%" expand="filter">
                    <filter id="filter" columnsCount="3" dataLoader="demandsDl">
                        <properties include=".*"/>
                        <configurations>
                            <configuration id="fltOnDemand" name="Demands filter" default="true">
                                <propertyFilter property="iprb.reference" caption="IPRB Reference"
                                                operation="CONTAINS"/>
                                <propertyFilter property="iprb.name" caption="IPRB Name" operation="CONTAINS"/>
                                <propertyFilter property="iprb.owner" caption="IPRB Owner" operation="CONTAINS"/>
                                <propertyFilter property="iprb.groupOffering" caption="Group Offering"
                                                operation="IN_LIST"/>
                            </configuration>
                        </configurations>
                    </filter>

                </hbox>
                <hbox spacing="true" expand="spacer" width="100%">
                    <button id="demandsTableRefreshBtn" action="demandsTable.refresh"/>
                    <button id="btnAdd" caption="Add missing IPRB's demand" icon="ADD_ACTION"/>
                    <button id="btnRemove" caption="Remove selected" icon="TRASH_O"/>
                    <button id="btnUpload" caption="Upload Excel" icon="CLOUD_UPLOAD"/>
                    <button id="demandsTableExcelExportBtn" action="demandsTable.excelExport"/>
                    <label id="spacer"/>
                    <pagination
                            align="MIDDLE_RIGHT"
                            itemsPerPageVisible="true"
                            itemsPerPageOptions="10,20,50,100"
                            itemsPerPageUnlimitedOptionVisible="true"
                            itemsPerPageDefaultValue="50">
                        <loaderProvider loaderId="demandsDl"/>
                    </pagination>
                </hbox>
                <dataGrid id="demandsTable"
                          selectionMode="MULTI"
                          width="100%"
                          dataContainer="demandsDc">
                    <actions>
                        <action id="refresh" type="refresh"/>
                        <action id="excelExport" type="excelExport"/>
                    </actions>
                    <columns>
                        <column id="iprb" property="iprb"/>
                        <column id="iprbName" property="iprb.name"/>
                        <column id="mdY" property="mdY"/>
                        <column id="mdQ1" property="mdQ1"/>
                        <column id="mdQ2" property="mdQ2"/>
                        <column id="mdQ3" property="mdQ3"/>
                        <column id="mdQ4" property="mdQ4"/>
                        <column id="euroAmount" property="euroAmount"/>
                        <column id="details" width="75px">
                            <componentRenderer/>
                        </column>
                        <column id="services" caption="Exp" width="75px">
                            <componentRenderer/>
                        </column>
                    </columns>
                </dataGrid>
            </tab>
            <tab caption="Details" id="detail" spacing="true" expand="detailsTable" margin="true,false,false,false">
                <filter id="detailsFilter" columnsCount="3" dataLoader="detailsDl">
                    <!-- <properties include=".*" excludeProperties="id,mdQ1,mdQ2,mdQ3,mdQ4,demand.id,demand.budget,demand.unicity,team.id"/>-->
                    <properties include=".*"/>
                    <configurations>
                        <configuration id="IPRBs" name="IPRBs">
                            <propertyFilter property="demand.iprb.activityType" operation="IN_LIST"
                                            caption="Activity Type"/>
                            <propertyFilter property="demand.iprb.legalEntity" operation="IN_LIST"
                                            caption="Legal Entity"/>
                            <propertyFilter property="demand.iprb.owner" operation="CONTAINS" caption="IPRB Owner"/>
                            <propertyFilter property="demand.iprb.portfolioClassification" operation="IN_LIST"
                                            caption="Portfolio Classification"/>
                            <propertyFilter property="demand.iprb.groupOffering" operation="IN_LIST"
                                            caption="Group Offering"/>
                            <propertyFilter property="demand.iprb.reference" operation="IN_LIST" caption="Reference"/>
                            <propertyFilter property="demand.iprb.strategicProgram" operation="IN_LIST"
                                            caption="Strategic Program"/>
                            <propertyFilter property="demand.iprb.name" operation="IN_LIST" caption="Name"/>


                        </configuration>
                    </configurations>
                </filter>
                <groupTable id="detailsTable" height="100%" width="100%" dataContainer="detailsDc">
                    <actions>
                        <action id="excelExport" type="excelExport"/>
                    </actions>
                    <buttonsPanel spacing="true">
                        <button id="detailsTableExcelExportBtn" action="detailsTable.excelExport"/>
                    </buttonsPanel>
                    <columns>
                        <column id="demand.iprb.name"/>
                        <column id="demand.iprb.reference"/>
                        <column id="roadmap"/>
                        <column id="detail"/>
                        <column id="team.name" caption="Team"/>
                        <column id="tShirt"/>
                        <column id="mdY"/>
                        <column id="mdQ1"/>
                        <column id="mdQ2"/>
                        <column id="mdQ3"/>
                        <column id="mdQ4"/>
                        <column id="priority"/>
                        <column id="topic"/>
                        <column id="category"/>
                        <column id="onePager"/>
                        <column id="team.tLine"/>
                        <column id="team.tDiv"/>
                        <column id="team.tDomain"/>

                        <column id="demand.iprb.groupOffering"/>
                        <column id="demand.iprb.outBudget"/>
                        <column id="demand.iprb.legalEntity"/>
                        <column id="demand.iprb.activityType"/>
                        <column id="demand.iprb.portfolioClassification"/>
                        <column id="demand.iprb.strategicProgram"/>

                        <column id="jira"/>
                        <column id="included"/>
                        <column id="simpleDomain" caption="Dash"/>
                        <!--                        <column id="simplePlatform" caption="Platform"/>-->
                    </columns>
                </groupTable>

            </tab>
            <tab id="pivot"

                 caption="Pivot Table"
                 spacing="true" margin="true,false,false,false">
                <pivot:pivotTable
                        dataContainer="detailsDc"
                        height="100%" width="100%"
                        autoSortUnusedProperties="true"
                        renderer="TABLE"
                        editable="true"
                        id="pivotTable">
                    <pivot:aggregationProperties>
                        <pivot:property name="mdY"/>
                        <pivot:property name="mdQ1"/>
                        <pivot:property name="mdQ2"/>
                        <pivot:property name="mdQ3"/>
                        <pivot:property name="mdQ4"/>
                    </pivot:aggregationProperties>
                    <pivot:aggregations>
                        <pivot:aggregation mode="SUM"/>
                        <pivot:aggregation mode="SUM_AS_FRACTION_OF_COLUMNS"/>
                        <pivot:aggregation mode="SUM_AS_FRACTION_OF_ROWS"/>
                        <pivot:aggregation mode="SUM_AS_FRACTION_OF_TOTAL"/>
                    </pivot:aggregations>
                    <pivot:hiddenFromAggregations>
                        
                        <pivot:property name="team.fullName"/>
                        <pivot:property name="roadmap"/>
                        <pivot:property name="team.tDiv"/>
                        <pivot:property name="team.tLine"/>
                        <pivot:property name="team.tDomain"/>
                        <pivot:property name="team.simplePlatform"/>
                        <pivot:property name="team.inBudget"/>
                        <pivot:property name="category"/>
                        <pivot:property name="onePager"/>
                        <pivot:property name="priority"/>
                        <pivot:property name="demand.iprb.reference"/>
                        <pivot:property name="demand.iprb.name"/>
                        <pivot:property name="demand.iprb.groupOffering"/>
                        <pivot:property name="demand.iprb.outBudget"/>
                        <pivot:property name="demand.iprb.legalEntity"/>
                        <pivot:property name="demand.iprb.activityType"/>
                        <pivot:property name="demand.iprb.portfolioClassification"/>
                    </pivot:hiddenFromAggregations>

                    <pivot:properties>

                        <pivot:property name="roadmap" localizedName="Demand Roadmap"/>
                        <pivot:property name="team.fullName" localizedName="Team Full Name"/>
                        <pivot:property name="team.tDiv" localizedName="Team GBD"/>
                        <pivot:property name="team.tLine" localizedName="Team GBL"/>
                        <pivot:property name="team.tDomain" localizedName="Team Domain"/>
                        <pivot:property name="team.inBudget" localizedName="Team in Budget"/>
                        <pivot:property name="team.simplePlatform" localizedName="Team Plaform"/>
                        <pivot:property name="category" localizedName="Demand Category"/>
                        <pivot:property name="mdY" localizedName="MD Year"/>
                        <pivot:property name="onePager" localizedName="Demand One Pager"/>
                        <pivot:property name="priority" localizedName="Demand Priority"/>
                        <pivot:property name="demand.iprb.reference" localizedName="IPRB Ref."/>
                        <pivot:property name="demand.iprb.name" localizedName="IPRB Name"/>
                        <pivot:property name="demand.iprb.groupOffering" localizedName="IPRB Gr Offer"/>
                        <pivot:property name="demand.iprb.outBudget" localizedName="IPRB Out Budget"/>
                        <pivot:property name="demand.iprb.legalEntity" localizedName="IPRB Owning Entity"/>
                        <pivot:property name="demand.iprb.activityType" localizedName="IPRB Act. Type"/>
                        <pivot:property name="demand.iprb.portfolioClassification" localizedName="IPRB Portfolio"/>
                        <pivot:property name="mdQ1"/>
                        <pivot:property name="mdQ2"/>
                        <pivot:property name="mdQ3"/>
                        <pivot:property name="mdQ4"/>
                    </pivot:properties>
                    <pivot:hiddenProperties>
                        <pivot:property name="mdQ1"/>
                        <pivot:property name="mdQ2"/>
                        <pivot:property name="mdQ3"/>
                        <pivot:property name="mdQ4"/>
                    </pivot:hiddenProperties>
                    <pivot:aggregation mode="SUM">
                        <pivot:property name="mdY"/>
                        <pivot:property name="mdQ1"/>
                        <pivot:property name="mdQ2"/>
                        <pivot:property name="mdQ3"/>
                        <pivot:property name="mdQ4"/>
                    </pivot:aggregation>
                </pivot:pivotTable>
            </tab>
        </tabSheet>

    </layout>
</window>